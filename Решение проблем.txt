Распределение функций и архитектурная логика
main.py

    Оркестрирует: получает тему, строит контекст, делает промпт, вызывает LLM, валидирует, постит, обновляет состояние.
    Не режет и не мутирует данные до передачи в профильные модули.
    Все логирование — через logs.py.
    Все ретраи — только для сетевых/лимитных ошибок и только на этапе публикации/генерации.

prompt_builder.py

    Только сборка промпта с контрольной структурой.
    Проверка всех плейсхолдеров.
    Возвращает tuple (prompt, has_uploadfile, prompt_template).
    Всегда возвращает строку, не None.

lm_client.py

    Только взаимодействие с LLM (LM Studio).
    Контролирует только лимит payload, не трогает лимиты Telegram.
    Обрезка context/history только по лимиту LLM.
    Возвращает только строку результата.

content_validator.py

    Вся фильтрация и обрезка по лимитам Telegram.
    Удаление таблиц, размышлений, спецсимволов, markdown-экранирование.
    Проверяет, что текст валидный и пригоден для публикации.
    Возвращает только строку.
